<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel • Yasemin Crochet World</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --brand:#8b5cf6; --brand-2:#ec4899; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.3);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 1200px at 10% -10%, rgba(139, 92, 246,.25), transparent 55%),
                  radial-gradient(1000px 1000px at 110% 10%, rgba(236, 72, 153,.18), transparent 40%),
                  var(--bg); color:var(--text);
    }
    .shell{max-width:1100px; margin:40px auto; padding:0 16px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:20px;
    }
    .title{font-weight:800; letter-spacing:.3px; font-size:20px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .grid{display:grid; gap:16px; grid-template-columns:1fr;}
    @media(min-width:900px){ .grid{grid-template-columns:420px 1fr;} }
    .pad{padding:18px}
    label{display:block; font-weight:600; margin:8px 0 6px; color:#cbd5e1}
    input, textarea, select{
      width:100%; padding:12px 14px; border-radius:12px; background:#0b1220; border:1px solid #202a3b; color:var(--text);
      outline: none;
    }
    textarea{min-height:110px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.1); cursor:pointer;
      background: linear-gradient(45deg, var(--brand), var(--brand-2)); color:#fff; font-weight:700;
      box-shadow:0 10px 18px rgba(139,92,246,.15), 0 6px 14px rgba(236,72,153,.12);
      transition:transform .08s ease;
    }
    .btn.sm{padding:8px 10px; font-weight:600; border-radius:12px}
    .btn.flat{background:#0b1220; border:1px solid #243047; font-weight:600}
    .btn:active{ transform: translateY(1px); }
    .toolbar{display:flex; align-items:center; gap:8px}
    .muted{color:var(--muted); font-size:13px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    th{text-align:left; color:#cbd5e1; font-weight:700}
    .tag{display:inline-block; padding:4px 8px; border-radius:9px; background:#0b1220; border:1px solid #22314a; font-size:12px; color:#cbd5e1}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #22314a; font-size:12px}
    .switch{position:relative; display:inline-block; width:48px; height:26px}
    .switch input{display:none}
    .slider{position:absolute; inset:0; background:#334155; border-radius:999px; transition:.2s}
    .slider:before{content:""; position:absolute; height:20px; width:20px; left:3px; top:3px; background:#fff; border-radius:50%; transition:.2s}
    input:checked + .slider{background:linear-gradient(45deg, var(--brand), var(--brand-2));}
    input:checked + .slider:before{transform:translateX(22px)}

    .auth{max-width:420px; margin:12vh auto}
    .center{display:flex; align-items:center; justify-content:center}
    .hidden{display:none !important}
    .danger{color:#fecaca}
    .ok{color:#bbf7d0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .footer-note{margin-top:10px; font-size:12px; color:#9aa3b2}
    .help{font-size:13px; margin-top:10px}
    .list-images{display:flex; flex-wrap:wrap; gap:6px}
    .list-images code{background:#0b1220; border:1px solid #22314a; padding:3px 6px; border-radius:8px}
  </style>
</head>
<body>
  <div id="screen-auth" class="auth card pad">
    <h2 style="margin:0 0 12px">Admin Girişi</h2>
    <p class="muted">Lütfen e‑posta ve şifrenizle giriş yapın.</p>
    <label for="email">E‑posta</label>
    <input id="email" type="email" placeholder="admin@ornek.com" autofocus>
    <label for="password">Şifre</label>
    <input id="password" type="password" placeholder="••••••••">
    <div class="toolbar" style="margin-top:14px">
      <button id="btnLogin" class="btn">Giriş Yap</button>
    </div>
    <div id="authMsg" class="help"></div>
    <p class="footer-note">Not: Bu panel yalnızca yetkili kullanıcılar içindir.</p>
  </div>

  <div id="screen-app" class="shell hidden">
    <header>
      <div class="title">Yönetim Paneli</div>
      <div class="toolbar">
        <span id="whoami" class="pill"><span>•</span> <strong class="mono"></strong></span>
        <button id="btnLogout" class="btn flat sm">Çıkış</button>
      </div>
    </header>

    <div class="grid">
      <!-- SOL: Ürün Formu -->
      <section class="card pad">
        <h3 style="margin:0 0 8px">Yeni Ürün</h3>
        <p class="muted" style="margin:0 0 12px">Fotoğrafları <code>/images</code> klasörüne <strong>manuel</strong> yükleyeceksiniz. Buraya sadece dosya adlarını yazın (virgülle).</p>
        <form id="productForm">
          <label>Başlık</label>
          <input id="fTitle" required placeholder="Örn. Örgü Kedi Yatağı">
          <div class="row">
            <div>
              <label>Fiyat (₺)</label>
              <input id="fPrice" type="number" min="0" step="0.01" required placeholder="250">
            </div>
            <div>
              <label>Kategori (opsiyonel)</label>
              <input id="fCategory" placeholder="Örn. Evcil">
            </div>
          </div>
          <label>Açıklama</label>
          <textarea id="fDesc" placeholder="Kısa açıklama..."></textarea>
          <label>Görseller (virgülle)</label>
          <input id="fImages" placeholder="kedi-yatagi1.jpg, kedi-yatagi2.jpg, kedi-yatagi3.jpg">
          <div style="display:flex; align-items:center; gap:12px; margin-top:10px">
            <label class="pill" style="gap:8px">
              <span>Aktif mi?</span>
              <label class="switch">
                <input id="fActive" type="checkbox" checked>
                <span class="slider"></span>
              </label>
            </label>
            <button class="btn" type="submit">Kaydet</button>
          </div>
          <div id="formMsg" class="help"></div>
        </form>
      </section>

      <!-- SAĞ: Ürün Listesi -->
      <section class="card pad">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <h3 style="margin:0">Ürünler</h3>
          <div class="muted" style="font-size:12px">Çift tıklama: düzenle</div>
        </div>
        <div style="margin-top:12px; overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>Başlık</th>
                <th>Fiyat</th>
                <th>Aktif</th>
                <th>Görseller</th>
                <th>İşlemler</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDJDi1LyAKemqWo-iI7jyVi58-1yh2guq4",
      authDomain: "yasemincrochetworld.firebaseapp.com",
      projectId: "yasemincrochetworld",
      storageBucket: "yasemincrochetworld.firebasestorage.app",
      messagingSenderId: "875729953548",
      appId: "1:875729953548:web:7189d80814a81c27475f29"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <script>
    // ======= Auth Ekranı
    const scrAuth = document.getElementById('screen-auth');
    const scrApp  = document.getElementById('screen-app');
    const authMsg = document.getElementById('authMsg');
    const whoami  = document.querySelector('#whoami .mono');

    document.getElementById('btnLogin').addEventListener('click', async () => {
      authMsg.textContent = "";
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value;
      if(!email || !pass){ authMsg.textContent="E‑posta ve şifre zorunlu."; return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(err){
        authMsg.textContent = "Giriş hatası: " + err.message;
      }
    });

    document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(user => {
      if(user){
        whoami.textContent = user.email || user.uid;
        scrAuth.classList.add('hidden');
        scrApp.classList.remove('hidden');
      }else{
        scrApp.classList.add('hidden');
        scrAuth.classList.remove('hidden');
      }
    });

    // ======= Form Kaydet
    const f = {
      title: document.getElementById('fTitle'),
      price: document.getElementById('fPrice'),
      category: document.getElementById('fCategory'),
      desc: document.getElementById('fDesc'),
      images: document.getElementById('fImages'),
      active: document.getElementById('fActive')
    };
    const formMsg = document.getElementById('formMsg');

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.textContent = "";
      try{
        const title = f.title.value.trim();
        const price = parseFloat(f.price.value);
        const desc  = f.desc.value.trim();
        const category = f.category.value.trim() || null;
        const images = f.images.value.split(',').map(s => s.trim()).filter(Boolean);
        const active = !!f.active.checked;
        if(!title || isNaN(price)){ formMsg.textContent="Başlık ve fiyat zorunlu."; return; }

        await db.collection('products').add({
          title, price, description: desc, category: category || null, images, active,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        e.target.reset(); f.active.checked = true;
        formMsg.textContent = "✅ Ürün eklendi.";
        formMsg.className = "help ok";
      }catch(err){
        formMsg.textContent = "Hata: " + err.message;
        formMsg.className = "help danger";
      }
    });

    // ======= Listele
    const tbody = document.querySelector('#tbl tbody');

    function renderRow(doc){
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.dataset.id = doc.id;
      const imgs = Array.isArray(d.images) ? d.images : [];
      tr.innerHTML = `
        <td><strong>${d.title || ""}</strong><div class="muted">${d.category || ""}</div></td>
        <td>₺${Number(d.price || 0).toFixed(2)}</td>
        <td>
          <label class="switch">
            <input type="checkbox" ${d.active ? "checked": ""} data-action="toggle">
            <span class="slider"></span>
          </label>
        </td>
        <td><div class="list-images">${imgs.map(x=>`<code>${x}</code>`).join(" ") || "<span class='muted'>-</span>"}</div></td>
        <td>
          <div class="toolbar">
            <button class="btn flat sm" data-action="edit">Düzenle</button>
            <button class="btn flat sm" data-action="delete">Sil</button>
          </div>
        </td>
      `;
      tr.addEventListener('dblclick', ()=> editDoc(doc.id, d));
      tr.querySelector('[data-action="edit"]').addEventListener('click', ()=> editDoc(doc.id, d));
      tr.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteDoc(doc.id));
      tr.querySelector('[data-action="toggle"]').addEventListener('change', (e)=> toggleActive(doc.id, e.target.checked));
      return tr;
    }

    function editDoc(id, d){
      f.title.value = d.title || "";
      f.price.value = d.price || "";
      f.category.value = d.category || "";
      f.desc.value  = d.description || "";
      f.images.value = (d.images || []).join(", ");
      f.active.checked = !!d.active;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      formMsg.textContent = "✏️ Düzenleme modundasınız. Kaydet'e basarsanız yeni ürün oluşur. Güncellemek için aşağıyı kullanın.";
      formMsg.className = "help";
      // Quick inline update banner could be added; separate Update button for clarity:
      ensureUpdateBar(id);
    }

    function ensureUpdateBar(id){
      if(document.getElementById('updateBar')) return;
      const bar = document.createElement('div');
      bar.id = 'updateBar';
      bar.className = 'toolbar';
      bar.style.marginTop = '10px';
      bar.innerHTML = `
        <button class="btn" id="btnApplyUpdate">Seçili Ürünü Güncelle</button>
        <button class="btn flat" id="btnCancelUpdate">İptal</button>
      `;
      document.getElementById('productForm').appendChild(bar);
      document.getElementById('btnApplyUpdate').addEventListener('click', async ()=>{
        try{
          const payload = {
            title: f.title.value.trim(),
            price: parseFloat(f.price.value),
            description: f.desc.value.trim(),
            category: f.category.value.trim() || null,
            images: f.images.value.split(',').map(s=>s.trim()).filter(Boolean),
            active: !!f.active.checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('products').doc(id).update(payload);
          formMsg.textContent = "✅ Ürün güncellendi.";
          formMsg.className = "help ok";
          cleanupUpdateBar();
        }catch(err){
          formMsg.textContent = "Güncelleme hatası: " + err.message;
          formMsg.className = "help danger";
        }
      });
      document.getElementById('btnCancelUpdate').addEventListener('click', cleanupUpdateBar);
    }

    function cleanupUpdateBar(){
      const bar = document.getElementById('updateBar');
      if(bar) bar.remove();
      document.getElementById('productForm').reset();
      f.active.checked = true;
      formMsg.textContent = "";
      formMsg.className = "help";
    }

    async function deleteDoc(id){
      if(!confirm("Bu ürünü silmek istiyor musunuz?")) return;
      try{
        await db.collection('products').doc(id).delete();
      }catch(err){
        alert("Silme hatası: " + err.message);
      }
    }

    async function toggleActive(id, val){
      try{
        await db.collection('products').doc(id).update({ active: !!val, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }catch(err){
        alert("Aktif/Pasif hatası: " + err.message);
      }
    }

    // canlı liste
    db.collection('products').orderBy('createdAt', 'desc').onSnapshot(ss => {
      tbody.innerHTML = "";
      ss.forEach(doc => tbody.appendChild(renderRow(doc)));
    });
  </script>
</body>
</html>
